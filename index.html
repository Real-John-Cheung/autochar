<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Automachar</title>
  <script src="node_modules/p5/lib/p5.min.js"></script>
  <script src="cutils.js"></script>
  <script src="automachar.js"></script>
  <script>
    var typer, word, tid, wmed='', def='';
    var showDefs = 1, showMed = 1, eraseSpeed = 0;
    var bg = 245, test = 0;

    function preload()
    {
      charData = loadJSON('chardata.json');
      wordData = loadJSON('words-trad.json');
    }

    function setup()
    {
      createCanvas(680, 490);
      textAlign(CENTER);
      textSize(14);

      util = new CharUtils(charData, wordData);
      typer = new Automachar(onActionComplete);
      word = typer.word.literal;
      def = showDefs ? util.definition(word) : '';
      console.log("    -> " + word, def);
      next();
    }

    function draw()
    {
      background(bg < 245 ? bg += 5 : bg);
      typer.draw(this._renderer, toHex(255 - bg));
      showDefs && text(def, width / 2, height - 10);
      showMed && text(wmed, width - 10, 15);
      test && noLoop();
    }

    function next()
    {
      typer.step();
      if (!test) {
        if (typer.nextAction()) { // drawing
          tid = setTimeout(next, random(400, 700));
        }
        else { // erasing
          eraseSpeed ? (tid = setTimeout(next, eraseSpeed)) : next();
        }
      }
    }

    function keyReleased()//Disabled()
    {
      if (false && key == ' ')
      {
        clearTimeout(tid);
        test = !test;
        if (!test)
        {
          next();
          loop();
        }
      }
      if (key == 's') {
        eraseSpeed = eraseSpeed > 0 ? 0 : 35;
      }
    }

    function onActionComplete(next, med)
    {
      if (next)
      {
        if (!test) bg = 0;
        //bell.play();
        if (showDefs) def = util.definition(next);
        console.log(word + " -> " + next, med, def);
        wmed = med;
        word = next;
      }
      else
      {
        //type.play();
      }
    }

    function toHex(gs)
    {
      var c = hex(gs, 2);
      return "#" + c + c + c;
    }

  </script>
</head>

<body>
</body>

</html>
